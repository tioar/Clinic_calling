<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>é™³è¬é¾è¨ºæ‰€çœ‹è¨ºé€²åº¦</title>
<meta name="description" content="å³æ™‚çœ‹è¨ºé€²åº¦èˆ‡é–€è¨ºè³‡è¨Š">
<meta name="theme-color" content="#34558b">

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- æœ¬åœ°å­—å‹ï¼šæ¨™æ¥·é«” / å‚™æ´æ¥·é«” -->
<style>
  /* ===== å­—å‹ï¼ˆä½  repo çš„ /fontsï¼‰ ===== */
  @font-face{
    font-family:"TW-Kai";
    src:url("./fonts/TW-Kai.woff2") format("woff2");
    font-weight:400; font-style:normal; font-display:swap;
  }
  @font-face{
    font-family:"CwTeXKai";
    src:url("./fonts/CwTeXKai.woff2") format("woff2");
    font-weight:400; font-style:normal; font-display:swap;
  }

  :root{
    --deep:#34558b;     /* Classic Blue */
    --light:#bfd2dd;    /* Baby Blue   */
    --ink:#1c2430;
    --bg:#f7f9fc;

    --accent:#9b8577;   /* å¡å…¶/æ£•ï¼ˆæé†’ç”¨ï¼‰ */
    --digit:#b71f1f;    /* å«è™Ÿç´… */
    --marq:#5DADEC;     /* è·‘é¦¬ç‡ˆåº•è‰²ï¼ˆä½ æŒ‡å®šï¼‰ */
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    /* å…¨ç«™æ¨™æ¥·é«” + å‚™æ´ */
    font-family: "TW-Kai","CwTeXKai","DFKai-SB","KaiTi","Kaiti TC","BiauKai",
                 "PingFang TC","Microsoft JhengHei",serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    display:flex; justify-content:center;
    padding: clamp(16px,4vw,40px);
  }

  /* ===== é›™å±¤å¤–æ¡†ï¼ˆå¤–æ·±è— / å…§æ·ºè—ï¼‰ ===== */
  .frame{
    border:3px solid var(--deep);
    padding:8px;              /* è®“å…§å±¤éœ²å‡º */
    background:#fff;
    max-width:min(940px,96vw);
    width:100%;
  }
  .frame-inner{
    border:2px solid var(--light);
    padding:clamp(18px,4vw,30px);
    background:#fff;
  }

  /* ===== è·‘é¦¬ç‡ˆ ===== */
  .marquee{
    --gap: 2rem; --speed: 45s;
    background:var(--marq); color:#fff;
    border:1px solid rgba(0,0,0,.06);
    padding:8px 0; border-radius:0;
    overflow:hidden; white-space:nowrap; user-select:none;
    /* å­—ç´šèˆ‡ä¸‹æ–¹æé†’ä¸€è‡´ */
    font-size:clamp(13px,2.6vw,15px); font-weight:700;
    letter-spacing:.5px;
    margin:0 0 12px 0;
  }
  .marquee__track{
    display:inline-flex; align-items:center; width:max-content;
    animation:marquee-loop var(--speed) linear infinite;
  }
  .marquee__track > span{ padding-right:var(--gap); flex-shrink:0; }
  .marquee:hover .marquee__track{ animation-play-state:paused; }
  @keyframes marquee-loop{ from{transform:translateX(0)} to{transform:translateX(-50%)} }

  /* ===== Logo ===== */
  .logo-wrap{ text-align:center; margin:6px 0 4px; }
  .logo{ height:clamp(110px,20vw,180px); max-width:82vw; object-fit:contain; background:#fff; }

  /* ===== æ¨™é¡Œ/æ™‚é–“ ===== */
  .title{ text-align:center; margin:8px 0 2px; }
  .title h1{
    margin:0; color:var(--deep);
    /* å­—å¤§ä¸€é»ï¼ˆä½ çš„è¦æ±‚ï¼‰ */
    font-size:clamp(28px,4.6vw,44px); font-weight:700; letter-spacing:2px;
  }
  .now-time{ text-align:center; color:#4b5f80; font-weight:700; margin:4px 0 10px; }

  /* ===== å…­é‚Šå½¢ç‹€æ…‹ ===== */
  .status-row{ text-align:center; margin:6px 0 12px; }
  .hex{
    position:relative; display:inline-block; color:#fff; font-weight:900;
    padding:.5rem 1.25rem; line-height:1; background:#d33e3e; /* é è¨­ç´…ï¼šä¼‘è¨º */
  }
  .hex::before,.hex::after{
    content:""; position:absolute; top:0; width:1.2em; height:100%; background:inherit;
  }
  .hex::before{ left:-.6em;  clip-path:polygon(100% 0,0 50%,100% 100%); }
  .hex::after { right:-.6em; clip-path:polygon(0 0,100% 50%,0 100%); }
  .hex.stop{ background:#e07a2a; }   /* åœæ­¢æ›è™Ÿï¼šæ©˜ */

  /* ===== å«è™Ÿå¡ï¼ˆé›™å±¤æ¡†ï¼‰ ===== */
  .num-outer{
    display:flex; justify-content:center;
    border:4px solid var(--deep); padding:8px; background:#fff;
  }
  .num-inner{
    border:3px solid var(--light); padding:clamp(10px,2.8vw,16px);
    background:transparent;            /* æ²’æœ‰åº•è‰² */
    min-width:min(86%, 860px);
  }
  .big-number{
    text-align:center; color:var(--digit);
    /* æ›´å¤§ã€éš¨è¢å¹•ç¸®æ”¾ */
    font-size:clamp(120px,22vw,320px);
    line-height:1; font-weight:900;
    /* æŒ‡å®šç”¨æ¨™æ¥·é«”ï¼ˆå†æ¬¡é–å®šï¼‰ */
    font-family:"TW-Kai","CwTeXKai","DFKai-SB","KaiTi","BiauKai",serif;
  }

  /* ===== èªéŸ³æé†’ï¼ˆæ ¸å–æ–¹å¡Š + éˆ´éºï¼‰ ===== */
  .voice{
    display:flex; align-items:center; justify-content:center; gap:10px;
    margin:10px 0 14px;
  }
  .voice .label{
    color:var(--accent); font-weight:900; letter-spacing:.5px;
    font-size:clamp(14px,3vw,18px);
  }
  .voice input[type="checkbox"]{
    appearance:none; width:20px; height:20px; margin:0;
    border:2px solid var(--accent); outline:none; cursor:pointer;
    background:#fff;
  }
  .voice input[type="checkbox"]:checked{
    background:var(--accent);
    box-shadow: inset 0 0 0 4px #fff;
  }
  .voice .bell{ font-size:20px; }

  /* ===== æ³¨æ„äº‹é … ===== */
  .note{
    background:#f2f6fb; border:1px solid var(--light);
    padding:16px 20px; margin:14px 0 4px; color:#274a6b;
    font-weight:700; border-radius:0;
  }
  .note p{ margin:.35em 0; font-size:clamp(13px,2.6vw,15px); }

  /* ç„¡éšœç¤™ï¼ˆçµ¦è®€å±ï¼‰ */
  .sr-only{
    position:absolute !important; width:1px; height:1px;
    padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
    border:0; white-space:nowrap;
  }
</style>
</head>

<body>
  <div class="frame">
    <div class="frame-inner">
      <!-- è·‘é¦¬ç‡ˆ -->
      <div class="marquee" aria-label="è¨ºæ‰€è¨Šæ¯è·‘é¦¬ç‡ˆ">
        <div class="marquee__track" id="marqueeTrack">
          <span>âœ¦ é™³è¬é¾è¨ºæ‰€é–€è¨ºæ™‚é–“ï¼šæ—©è¨º 08:30â€“11:30ï¼ˆæœ€æ™šå ±åˆ°10:30ï¼‰ï¼åˆè¨º 14:00â€“17:00ï¼ˆæœ€æ™šå ±åˆ°16:00ï¼‰ï¼æ™šè¨º 18:00â€“20:30ï¼ˆæœ€æ™šå ±åˆ°20:00ï¼‰ã€‚é›²ç«¯è™Ÿç¢¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›å«è™Ÿä»¥ç¾å ´ç‚ºæº–ã€‚</span>
          <span aria-hidden="true">âœ¦ é™³è¬é¾è¨ºæ‰€é–€è¨ºæ™‚é–“ï¼šæ—©è¨º 08:30â€“11:30ï¼ˆæœ€æ™šå ±åˆ°10:30ï¼‰ï¼åˆè¨º 14:00â€“17:00ï¼ˆæœ€æ™šå ±åˆ°16:00ï¼‰ï¼æ™šè¨º 18:00â€“20:30ï¼ˆæœ€æ™šå ±åˆ°20:00ï¼‰ã€‚é›²ç«¯è™Ÿç¢¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›å«è™Ÿä»¥ç¾å ´ç‚ºæº–ã€‚</span>
        </div>
      </div>

      <!-- LOGOï¼ˆç„¡é‚Šæ¡†ï¼Œèˆ‡ç™½åº•ç›¸èï¼‰ -->
      <div class="logo-wrap">
        <img class="logo" id="clinicLogo" src="./logo1.jpg" alt="é™³è¬é¾è¨ºæ‰€ LOGO">
      </div>

      <!-- æ¨™é¡Œï¼æ™‚é–“ -->
      <div class="title">
        <h1>ç›®å‰çœ‹è¨ºè™Ÿç¢¼</h1>
      </div>
      <div class="now-time" id="twTime">â€”</div>

      <!-- ç‹€æ…‹å…­é‚Šå½¢ï¼ˆç§»åˆ°æ¨™é¡Œèˆ‡æ™‚é–“ä¸‹é¢ï¼‰ -->
      <div class="status-row" id="statusRow"></div>

      <!-- å«è™Ÿå€ï¼šé›™å±¤æ¡†ã€æ•¸å­—ç„¡åº•è‰²ã€ä¸è£œ 0 -->
      <div class="num-outer">
        <div class="num-inner">
          <div id="bigNumber" class="big-number">0</div>
        </div>
      </div>

      <!-- èªéŸ³å«è™Ÿï¼ˆæ ¸å–æ–¹å¡Š + éˆ´éºï¼‰ -->
      <div class="voice">
        <div class="label">é–‹å•ŸèªéŸ³å«è™Ÿæé†’</div>
        <input type="checkbox" id="voiceToggle" aria-checked="false" role="checkbox" />
        <div id="bell" class="bell" aria-hidden="true">ğŸ”•</div>
      </div>
      <div id="srStatus" class="sr-only" aria-live="polite"></div>

      <!-- æ³¨æ„äº‹é … -->
      <div class="note">
        <p>â™¦ï¸ é›²ç«¯è™Ÿç¢¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›å«è™Ÿä»¥ç¾å ´ç‚ºæº–ã€‚æ¯ä½æ‚£è€…ç´„ 3â€“5 åˆ†é˜ï¼Œè«‹æå‰åˆ°å ´åœ¨å¯çœ‹åˆ°ç‡ˆè™Ÿçš„ä½ç½®ç­‰å€™ä»¥å…éè™Ÿã€‚</p>
        <p>â™¦ï¸ è‹¥å·²éè™Ÿè«‹å†æ¬¡å‘æ«ƒæª¯å ±åˆ°ï¼Œå°‡ä¾ç¾å ´ç‹€æ³èª¿æ•´å®‰æ’ï¼›é–€è¨ºå¯èƒ½è¦–ç¾å ´ç‹€æ³æå‰åœæ­¢æ›è™Ÿï¼Œå¦‚æœ‰ç–‘å•è«‹ä¾†é›» (03) 515-2971ã€‚</p>
      </div>
    </div>
  </div>

<script>
  /* åœ–ç‰‡å‚™æ´ */
  (function(){
    const logo = document.getElementById('clinicLogo');
    const logoFallbacks = [
      './logo.png',
      'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo1.jpg',
      'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo.png'
    ];
    let li=0;
    logo.onerror = function(){
      if(li<logoFallbacks.length){ this.src=logoFallbacks[li++]; }
      else { this.style.display='none'; }
    };
  })();

  /* è·‘é¦¬ç‡ˆæ»‘å‹•æ§åˆ¶ï¼ˆæŒ‰ä½æš«åœï¼‰ */
  (function(){
    const marquee = document.querySelector('.marquee');
    const track = document.getElementById('marqueeTrack');
    const pause = () => track.style.animationPlayState = 'paused';
    const run   = () => track.style.animationPlayState = 'running';
    marquee.addEventListener('pointerdown', pause);
    marquee.addEventListener('pointerup', run);
    marquee.addEventListener('pointerleave', run);
    marquee.addEventListener('pointercancel', run);
  })();

  /* ===== åŸºæœ¬è¨­å®šï¼ˆæŠ“è™Ÿï¼‰ ===== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec";
  const POLL_MS = 1500;
  const FETCH_TIMEOUT = 1200;

  const bigNumber = document.getElementById('bigNumber');
  const statusRow = document.getElementById('statusRow');
  const srStatus  = document.getElementById('srStatus');

  let lastNumber = -1;

  /* ===== èªéŸ³è¨­å®šï¼ˆæ ¸å–æ–¹å¡Šï¼‰ ===== */
  const voiceToggle = document.getElementById('voiceToggle');
  const bell = document.getElementById('bell');
  const Voice = { enabled:false, unlocked:false, voices:[], zh:null };

  function loadVoices(){
    const list = window.speechSynthesis?.getVoices?.() || [];
    Voice.voices = list;
    Voice.zh =
      list.find(v => (v.lang||'').toLowerCase().startsWith('zh-tw')) ||
      list.find(v => (v.lang||'').toLowerCase().startsWith('zh-hk')) ||
      list.find(v => (v.lang||'').toLowerCase().startsWith('zh-cn')) ||
      list.find(v => (v.lang||'').toLowerCase().startsWith('zh'));
  }
  function unlockTTS(){
    if(!('speechSynthesis' in window)) return false;
    loadVoices();
    if(typeof speechSynthesis.onvoiceschanged!=='undefined'){
      speechSynthesis.onvoiceschanged = () => loadVoices();
    }
    try{ speechSynthesis.resume(); }catch(e){}
    Voice.unlocked = true; return true;
  }
  function zhRead(n){
    n = Math.max(0, Math.min(999, Math.floor(n)));
    const d = ['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
    if (n === 0) return 'é›¶';
    let out = '', h = Math.floor(n/100), t = Math.floor((n%100)/10), u = n%10;
    if(h>0){ out += d[h]+'ç™¾'; if(t===0 && u>0) out+='é›¶'; }
    if(t>0){ out += (t===1 && h===0 ? '' : d[t]) + 'å'; }
    if(u>0){ out += d[u]; }
    return out;
  }
  function speakNumber(n){
    if(!Voice.enabled) return;
    const txt = `${zhRead(n)}è™Ÿã€${zhRead(n)}è™Ÿè«‹é€²è¨ºé–“ã€‚`;
    const u = new SpeechSynthesisUtterance(txt);
    if(!Voice.zh || !Voice.voices.length) loadVoices();
    if(Voice.zh) u.voice = Voice.zh;
    u.lang = (Voice.zh && Voice.zh.lang) || 'zh-TW';
    u.rate = .6; u.pitch = 1;
    try{ speechSynthesis.resume(); }catch(e){}
    speechSynthesis.speak(u);
  }

  voiceToggle.addEventListener('change', ()=>{
    const on = voiceToggle.checked;
    voiceToggle.setAttribute('aria-checked', on ? 'true':'false');
    Voice.enabled = on;
    bell.textContent = on ? 'ğŸ””' : 'ğŸ”•';
    if(on && !Voice.unlocked) unlockTTS();
    srStatus.textContent = on ? 'å·²é–‹å•ŸèªéŸ³å«è™Ÿæé†’' : 'å·²é—œé–‰èªéŸ³å«è™Ÿæé†’';
  });
  // è§¸æ§ä¸€æ¬¡è§£é–
  window.addEventListener('touchend', function once(){
    if(!Voice.unlocked) unlockTTS();
    window.removeEventListener('touchend', once, true);
  }, true);

  /* ===== UI ===== */
  function setNumber(n){
    // ä¸è£œ 0ï¼šç›´æ¥é¡¯ç¤ºå¯¦éš›è™Ÿç¢¼
    bigNumber.textContent = String(n);
    srStatus.textContent = `ç›®å‰çœ‹è¨ºè™Ÿç¢¼ï¼š${n}`;
  }
  function renderStatus(data){
    statusRow.innerHTML = '';
    if (data && data.holiday === true){
      const el = document.createElement('div');
      el.className = 'hex';
      el.textContent = 'ç¾åœ¨æ™‚é–“æ²’æœ‰é–€è¨ºï¼Œä¼‘è¨ºä¸­';
      statusRow.appendChild(el);
    }else if (data && data.closed === true){
      const el = document.createElement('div');
      el.className = 'hex stop';
      el.textContent = 'ç•¶å‰æ™‚æ®µé–€è¨ºå·²åœæ­¢æ›è™Ÿ';
      statusRow.appendChild(el);
    }
  }

  /* ===== æŠ“è™Ÿ ===== */
  async function fetchJSON() {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), FETCH_TIMEOUT);
    const res = await fetch(`${GAS_URL}?ts=${Date.now()}`, { cache:'no-store', signal: ctrl.signal });
    clearTimeout(t);
    if(!res.ok) throw new Error(res.statusText);
    return res.json();
  }
  function fetchJSONP() {
    return new Promise((resolve, reject) => {
      const cbName = 'onClinicData_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
      const s = document.createElement('script');
      const timeout = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, 5000);
      window[cbName] = (data) => { cleanup(); resolve(data); };
      function cleanup(){ clearTimeout(timeout); delete window[cbName]; s.remove(); }
      s.src = `${GAS_URL}?callback=${cbName}&ts=${Date.now()}`;
      s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
      document.head.appendChild(s);
    });
  }

  async function fetchNumber(){
    try{
      const data = await fetchJSON().catch(async () => await fetchJSONP());
      renderStatus(data);
      const n = Number(data.number);
      if (!Number.isFinite(n) || n < 0 || n >= 1000) return;
      if (n !== lastNumber){
        setNumber(n);
        if(Voice.enabled) speakNumber(n);
        lastNumber = n;
      }
    }catch(_){}
  }

  /* æ™‚é˜ï¼ˆå°ç£æ™‚å€ï¼‰ */
  const pad2 = n => String(n).padStart(2,'0');
  function updateTWTime(){
    const el=document.getElementById('twTime');
    const now = new Date();
    const tw = new Date(now.toLocaleString('en-US', { timeZone:'Asia/Taipei' }));
    const wMap=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    el.textContent = `${tw.getFullYear()}/${pad2(tw.getMonth()+1)}/${pad2(tw.getDate())}ï¼ˆ${wMap[tw.getDay()]}ï¼‰ `+
                     `${pad2(tw.getHours())}:${pad2(tw.getMinutes())}:${pad2(tw.getSeconds())}`;
  }

  // å•Ÿå‹•
  fetchNumber(); setInterval(fetchNumber, POLL_MS);
  updateTWTime(); setInterval(updateTWTime, 1000);
</script>
</body>
</html>
