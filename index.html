<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>陳萬龍診所看診進度</title>
<meta name="description" content="即時看診進度與門診資訊">
<meta name="theme-color" content="#35579A">

<meta property="og:type" content="website">
<meta property="og:title" content="陳萬龍診所｜看診進度">
<meta property="og:description" content="即時看診進度與門診資訊。">
<meta property="og:image" content="og-cover.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://tioar.github.io/Clinic_calling/">
<meta property="og:locale" content="zh_TW">

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
/* ===== 本地楷體 ===== */
@font-face{
  font-family:"TW-Kai";
  src:url("./fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CwTeXKai";
  src:url("./fonts/CwTeXKai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
/* ✅ 只給數字用的楷體（強制 iPhone 也吃楷體 0–9） */
@font-face{
  font-family:"KaiDigits";
  src:url("./fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
  unicode-range: U+0030-0039; /* 0-9 */
}

:root{
  --primary:#35579A;
  --soft:#A5B8D0;
  --light:#EAF1FF;
  --beige:#D8C0AD;
  --digit-red:#B91C1C;
  --pill-red:#E53935;
  --pill-coral:#F37163;

  --text-font: "TW-Kai","CwTeXKai","Kaiti TC","KaiTi","BiauKai",
               "LXGW WenKai TC","DFKai-SB","Microsoft JhengHei",serif;
  /* 大號碼改用 KaiDigits 優先，確保 iPhone 是楷體 */
  --digit-font: "KaiDigits","TW-Kai","CwTeXKai","Kaiti TC","KaiTi","BiauKai",
                "LXGW WenKai TC",serif;
}

*{box-sizing:border-box}
body{
  font-family:var(--text-font);
  -webkit-font-smoothing:antialiased;
  background:#fff; margin:0;
  padding:clamp(16px,4vw,40px);
  display:flex; justify-content:center; color:#1c1c1c;
}
/* 最大卡片：細邊＋雙層陰影 */
.container{
  width:min(920px,96vw); background:#fff;
  border:1.5px solid var(--soft);
  padding:clamp(16px,4vw,32px);
  text-align:center;
  box-shadow:
    0 18px 40px rgba(53,87,154,.16),
    0 2px 6px rgba(17,24,39,.08);
}

/* 跑馬燈：#658DC6 白字，字級與注意事項一致 */
.marquee{
  --gap:2rem; --speed:45s;
  background:#658DC6; color:#fff;
  padding:10px 0; margin:0 auto 14px;
  overflow:hidden; white-space:nowrap; user-select:none;
  font-size:clamp(14px,2vw,16px); font-weight:700;
}
.marquee__track{display:inline-flex; align-items:center; width:max-content; animation:marquee-loop var(--speed) linear infinite;}
.marquee__track > span{padding-right:var(--gap)}
.marquee:hover .marquee__track{animation-play-state:paused}
@keyframes marquee-loop{from{transform:translateX(0)}to{transform:translateX(-50%)}}

.logo{height:clamp(120px,22vw,200px); max-width:82vw; object-fit:contain; display:block; margin:10px auto 6px}

/* 標題更大 */
.title-row h1{
  margin:0; color:#1f2f63;
  font-size:clamp(32px,5vw,48px); font-weight:800; letter-spacing:.7px;
}

/* ✅ 目前年月日時間 放大 */
.now-time{
  color:#35579A; font-weight:800; margin-bottom:8px;
  font-size:clamp(16px,3.6vw,22px);
}

/* 六邊形標籤（長條）＋字體放大 */
.pill-wrap{display:flex; justify-content:center; margin:8px 0 12px}
.hex{
  --cut:18px;
  display:inline-block; padding:.6rem 1.6rem;
  color:#fff; font-weight:800; letter-spacing:.6px;
  clip-path:polygon(var(--cut) 0, calc(100% - var(--cut)) 0, 100% 50%, calc(100% - var(--cut)) 100%, var(--cut) 100%, 0 50%);
  box-shadow:0 6px 16px rgba(0,0,0,.12);
  font-size:clamp(14px,3.6vw,20px);   /* ✅ 放大 */
}
.hex.red{background:var(--pill-red)}
.hex.coral{background:var(--pill-coral)}

/* 叫號：無底色、楷體、更大、不補零 */
.number-box{display:inline-block; margin:4px auto 12px}
.number{
  font-family:var(--digit-font);
  font-size:clamp(120px,20vw,260px); /* ✅ 已很大 */
  line-height:1; color:var(--digit-red);
  letter-spacing:.02em; font-weight:700;
}
@keyframes pop{0%{transform:scale(.96);opacity:.85}100%{transform:scale(1);opacity:1}}
.pop{animation:pop .28s ease-out}

/* 語音核取方塊 + 🔔/🔕 */
.voice-row{display:flex; align-items:center; justify-content:center; gap:12px; margin:8px 0 16px}
.voice-label{font-weight:900; color:#3b2e1e; letter-spacing:.5px; font-size:clamp(16px,3vw,20px)}
.chk{width:22px; height:22px; margin:0; accent-color:var(--beige); appearance:auto; cursor:pointer}
.bell{font-size:22px; line-height:1}

/* ✅ 注意事項整段放大（含行高） */
.note{
  background:#F2F6FB; padding:18px 22px; border:none;
  margin:14px auto 12px; color:#274a6b; font-weight:700;
  width:min(760px,100%); text-align:center;
  font-size:clamp(14px,3.2vw,18px); line-height:1.75;
}
.note p{margin:.35em 0}

.palette{height:8px; margin:8px auto 14px; width:min(560px,90%); background:linear-gradient(to right,#D8C0AD 0 22%,#6db337 22% 45%,#35579A 45% 82%,#A5B8D0 82% 100%)}
.schedule{margin-top:6px; max-width:100%; border:none; box-shadow:none}

/* 螢幕閱讀器用 */
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; white-space:nowrap}
</style>
</head>

<body>
  <div class="container">
    <!-- 跑馬燈 -->
    <div class="marquee" aria-label="診所訊息跑馬燈">
      <div class="marquee__track" id="marqueeTrack">
        <span>✦ 陳萬龍診所門診時間：☀︎ 早診 08:30–11:30（最晚報到10:30）；☁︎ 午診 14:00–17:00（最晚報到16:00）；☾ 晚診 18:00–20:30（最晚報到20:00）。逾時視同放棄，名額將釋出給現場掛號。</span>
        <span aria-hidden="true">✦ 陳萬龍診所門診時間：☀︎ 早診 08:30–11:30（最晚報到10:30）；☁︎ 午診 14:00–17:00（最晚報到16:00）；☾ 晚診 18:00–20:30（最晚報到20:00）。逾時視同放棄，名額將釋出給現場掛號。</span>
      </div>
    </div>

    <img class="logo" id="clinicLogo" src="./logo1.jpg" alt="陳萬龍診所 LOGO">

    <div class="title-row"><h1 id="sectionTitle">目前看診號碼</h1></div>
    <div class="now-time" id="twTime">—</div>

    <!-- 六邊形標籤 -->
    <div class="pill-wrap" aria-live="polite" id="statusPill"></div>

    <!-- 叫號（無底色、不補0） -->
    <div class="number-box"><div id="bigNumber" class="number">—</div></div>

    <!-- 語音開關 -->
    <div class="voice-row">
      <label class="voice-label" for="voiceToggle">開啟語音叫號提醒</label>
      <input type="checkbox" id="voiceToggle" class="chk" aria-checked="false" aria-labelledby="voiceToggle"/>
      <span id="bell" class="bell" aria-hidden="true">🔕</span>
      <div id="voiceHint" class="sr-only">勾選後，號碼變更時會自動語音播報。</div>
    </div>

    <div id="srStatus" class="sr-only" aria-live="polite"></div>

    <div class="note">
      <p>♦︎ 雲端號碼僅供參考，實際叫號以現場為準。每位病患約 3–5 分鐘，請提前到場在可看到燈號的位置等候以免過號。</p>
      <p>♦︎ 若已過號請再次向櫃檯報到，將依現場狀況調整安排。門診可能視現場狀況提前停止掛號，如有疑問請來電 (03)515-2971。</p>
    </div>

    <div class="palette" aria-hidden="true"></div>
    <img class="schedule" id="scheduleImg" src="./schedule.png" alt="門診時間表">
  </div>

<script>
/* 跑馬燈暫停/恢復 */
(function(){
  const marquee=document.querySelector('.marquee');
  const track=document.getElementById('marqueeTrack');
  const pause=()=>track.style.animationPlayState='paused';
  const run=()=>track.style.animationPlayState='running';
  marquee.addEventListener('pointerdown',pause);
  marquee.addEventListener('pointerup',run);
  marquee.addEventListener('pointerleave',run);
  marquee.addEventListener('pointercancel',run);
})();

/* 圖片備援 */
(function(){
  const logo=document.getElementById('clinicLogo');
  const logoFallbacks=['./logo.png',
    'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo1.jpg',
    'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo.png'];
  let li=0; logo.onerror=function(){ if(li<logoFallbacks.length){ this.src=logoFallbacks[li++]; } else { this.style.display='none'; } };

  const sch=document.getElementById('scheduleImg');
  const schFallbacks=['https://raw.githubusercontent.com/tioar/Clinic_calling/main/schedule.png'];
  let si=0; sch.onerror=function(){ if(si<schFallbacks.length){ this.src=schFallbacks[si++]; } else { this.style.display='none'; } };
})();

let lastNumber=''; /* 不預設 000 */

/* 抓號設定 */
const POLL_MS=1500;
const FETCH_TIMEOUT=1200;
const GAS_URL="https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec";

/* ===== 語音設定 ===== */
const TTS_RATE=0.55;
const UA=navigator.userAgent.toLowerCase();
const isWinChrome=UA.includes('windows')&&UA.includes('chrome')&&!UA.includes('edg');
const WARM_CANCEL_DELAY=isWinChrome?220:120;
const WARM_PLAY_DELAY=isWinChrome?100:60;
const WARM_SAFETY_MS=isWinChrome?800:650;

const Voice={ready:false, unlocked:false, voices:[], zhVoice:null, enabled:false, timer:null};
function loadVoices(){
  const list=window.speechSynthesis?.getVoices?.()||[];
  Voice.voices=list;
  Voice.zhVoice=
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-tw'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-hk'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-cn'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh'));
}
function unlockTTS(){
  if(!('speechSynthesis' in window)){ alert('此瀏覽器不支援語音播報'); return false; }
  loadVoices();
  if(typeof speechSynthesis.onvoiceschanged!=='undefined'){ speechSynthesis.onvoiceschanged=()=>loadVoices(); }
  try{ speechSynthesis.resume(); }catch(e){}
  Voice.unlocked=true; Voice.ready=true; return true;
}
function speakText(txt){
  if(!Voice.ready||!txt) return;
  if(!Voice.enabled && !speakText._oneshot) return;
  const play=()=>{
    const warm=new SpeechSynthesisUtterance('\u00A0');
    warm.lang=(Voice.zhVoice&&Voice.zhVoice.lang)||'zh-TW';
    warm.rate=TTS_RATE; warm.pitch=1; warm.volume=0;
    const safety=setTimeout(()=>{ try{ speechSynthesis.cancel(); }catch(e){} reallySpeak(txt); }, isWinChrome?800:650);
    warm.onend=()=>{ clearTimeout(safety); setTimeout(()=>reallySpeak(txt), isWinChrome?100:60); };
    try{ speechSynthesis.resume(); }catch(e){}
    speechSynthesis.speak(warm);
  };
  if(speechSynthesis.speaking||speechSynthesis.pending){
    try{ speechSynthesis.cancel(); }catch(e){}
    setTimeout(play, isWinChrome?220:120);
  }else{
    setTimeout(play, isWinChrome?100:60);
  }
}
function reallySpeak(txt){
  const u=new SpeechSynthesisUtterance((UA.includes('windows')?'\u3000，':'')+String(txt).replace(/[~～]+$/g,'。'));
  if(!Voice.zhVoice||!Voice.voices.length) loadVoices();
  if(Voice.zhVoice) u.voice=Voice.zhVoice;
  u.lang=(Voice.zhVoice&&Voice.zhVoice.lang)||'zh-TW';
  u.rate=TTS_RATE; u.pitch=1; u.volume=1;
  u.onstart=()=>{ try{ speechSynthesis.resume(); }catch(e){} };
  speechSynthesis.speak(u);
}
function zhRead(n){
  n=Math.max(0,Math.min(999,Math.floor(n)));
  const d=['零','一','二','三','四','五','六','七','八','九'];
  if(n===0) return '零';
  let out='',h=Math.floor(n/100),t=Math.floor((n%100)/10),u=n%10;
  if(h>0){ out+=d[h]+'百'; if(t===0 && u>0) out+='零'; }
  if(t>0){ out+=(t===1 && h===0?'':d[t])+'十'; }
  if(u>0){ out+=d[u]; }
  return out;
}
function speakNumber(n){ speakText(`${zhRead(n)}號、${zhRead(n)}號請進診間。`); }

/* SR */
const srStatus=document.getElementById('srStatus');
function sayToSR(text){ srStatus.textContent=text; }

/* 語音核取方塊 */
const voiceToggle=document.getElementById('voiceToggle');
const bell=document.getElementById('bell');
voiceToggle.addEventListener('change',()=>{
  voiceToggle.setAttribute('aria-checked', voiceToggle.checked?'true':'false');
  bell.textContent=voiceToggle.checked?'🔔':'🔕';
  if(voiceToggle.checked){
    if(!Voice.unlocked && !unlockTTS()){ voiceToggle.checked=false; voiceToggle.setAttribute('aria-checked','false'); bell.textContent='🔕'; return; }
    Voice.enabled=true;
    speakText._oneshot=true; speakText('已開啟語音叫號提醒。'); speakText._oneshot=false;
    sayToSR('已開啟語音叫號提醒');
  }else{
    Voice.enabled=false; try{ speechSynthesis.cancel(); }catch(e){}
    sayToSR('已關閉語音叫號提醒');
  }
});
window.addEventListener('touchend',function once(){ if(!Voice.unlocked){ unlockTTS(); } window.removeEventListener('touchend',once,true); },true);
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ try{ speechSynthesis.resume(); }catch(e){} }});

/* 抓號（不補 0） */
async function fetchJSON(){
  const ctrl=new AbortController();
  const t=setTimeout(()=>ctrl.abort(), 1200);
  const res=await fetch(`${"https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec"}?ts=${Date.now()}`,{cache:'no-store', signal:ctrl.signal});
  clearTimeout(t);
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}
function fetchJSONP(){
  return new Promise((resolve,reject)=>{
    const cb='onClinic_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    const s=document.createElement('script');
    const done=()=>{ delete window[cb]; s.remove(); };
    const to=setTimeout(()=>{ done(); reject(new Error('jsonp timeout')); },5000);
    window[cb]=(d)=>{ clearTimeout(to); done(); resolve(d); };
    s.src=`https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec?callback=${cb}&ts=${Date.now()}`;
    s.onerror=()=>{ clearTimeout(to); done(); reject(new Error('jsonp error')); };
    document.head.appendChild(s);
  });
}

function renderStatusPill(data){
  const box=document.getElementById('statusPill');
  box.innerHTML='';
  if(data.holiday===true){
    const el=document.createElement('div'); el.className='hex red'; el.textContent='現在時間沒有門診，休診中'; box.appendChild(el);
  }else if(data.closed===true){
    const el=document.createElement('div'); el.className='hex coral'; el.textContent='當前時段已停止掛號'; box.appendChild(el);
  }
}
function animateNumberText(text){
  const el=document.getElementById('bigNumber');
  el.textContent=text;
  el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop');
}
async function fetchNumber(){
  try{
    const data=await fetchJSON().catch(async()=>await fetchJSONP());
    renderStatusPill(data);
    const n=Number(data.number);
    if(!Number.isFinite(n)||n<0||n>=1000) return;
    const current=String(n); // 不補 0
    if(current!==lastNumber){
      animateNumberText(current);
      sayToSR(`目前看診號碼：${current}`);
      if(Voice.enabled) speakNumber(n);
      lastNumber=current;
    }
  }catch(e){}
}

/* 時間 */
const pad2=n=>String(n).padStart(2,'0');
function updateTWTime(){
  const el=document.getElementById('twTime');
  const now=new Date();
  const tw=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const w=['日','一','二','三','四','五','六'];
  el.textContent=`${tw.getFullYear()}/${pad2(tw.getMonth()+1)}/${pad2(tw.getDate())} (${w[tw.getDay()]}) ${pad2(tw.getHours())}:${pad2(tw.getMinutes())}:${pad2(tw.getSeconds())}`;
}

/* 啟動 */
fetchNumber(); setInterval(fetchNumber, 1500);
updateTWTime(); setInterval(updateTWTime, 1000);
</script>
</body>
</html>
