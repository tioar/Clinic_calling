<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>é™³è¬é¾è¨ºæ‰€çœ‹è¨ºé€²åº¦</title>
<meta name="description" content="å³æ™‚çœ‹è¨ºé€²åº¦èˆ‡é–€è¨ºè³‡è¨Š">
<meta name="theme-color" content="#35579A">

<meta property="og:type" content="website">
<meta property="og:title" content="é™³è¬é¾è¨ºæ‰€ï½œçœ‹è¨ºé€²åº¦">
<meta property="og:description" content="å³æ™‚çœ‹è¨ºé€²åº¦èˆ‡é–€è¨ºè³‡è¨Šã€‚">
<meta property="og:image" content="og-cover.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://tioar.github.io/Clinic_calling/">
<meta property="og:locale" content="zh_TW">

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
/* ===== æœ¬åœ°æ¥·é«” ===== */
@font-face{
  font-family:"TW-Kai";
  src:url("./fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CwTeXKai";
  src:url("./fonts/CwTeXKai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
/* âœ… åªçµ¦æ•¸å­—ç”¨çš„æ¥·é«”ï¼ˆå¼·åˆ¶ iPhone ä¹Ÿåƒæ¥·é«” 0â€“9ï¼‰ */
@font-face{
  font-family:"KaiDigits";
  src:url("./fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
  unicode-range: U+0030-0039; /* 0-9 */
}

:root{
  --primary:#35579A;
  --soft:#A5B8D0;
  --light:#EAF1FF;
  --beige:#D8C0AD;
  --digit-red:#B91C1C;
  --pill-red:#E53935;
  --pill-coral:#F37163;

  --text-font: "TW-Kai","CwTeXKai","Kaiti TC","KaiTi","BiauKai",
               "LXGW WenKai TC","DFKai-SB","Microsoft JhengHei",serif;
  /* å¤§è™Ÿç¢¼æ”¹ç”¨ KaiDigits å„ªå…ˆï¼Œç¢ºä¿ iPhone æ˜¯æ¥·é«” */
  --digit-font: "KaiDigits","TW-Kai","CwTeXKai","Kaiti TC","KaiTi","BiauKai",
                "LXGW WenKai TC",serif;
}

*{box-sizing:border-box}
body{
  font-family:var(--text-font);
  -webkit-font-smoothing:antialiased;
  background:#fff; margin:0;
  padding:clamp(16px,4vw,40px);
  display:flex; justify-content:center; color:#1c1c1c;
}
/* æœ€å¤§å¡ç‰‡ï¼šç´°é‚Šï¼‹é›™å±¤é™°å½± */
.container{
  width:min(920px,96vw); background:#fff;
  border:1.5px solid var(--soft);
  padding:clamp(16px,4vw,32px);
  text-align:center;
  box-shadow:
    0 18px 40px rgba(53,87,154,.16),
    0 2px 6px rgba(17,24,39,.08);
}

/* è·‘é¦¬ç‡ˆï¼š#658DC6 ç™½å­—ï¼Œå­—ç´šèˆ‡æ³¨æ„äº‹é …ä¸€è‡´ */
.marquee{
  --gap:2rem; --speed:45s;
  background:#658DC6; color:#fff;
  padding:10px 0; margin:0 auto 14px;
  overflow:hidden; white-space:nowrap; user-select:none;
  font-size:clamp(14px,2vw,16px); font-weight:700;
}
.marquee__track{display:inline-flex; align-items:center; width:max-content; animation:marquee-loop var(--speed) linear infinite;}
.marquee__track > span{padding-right:var(--gap)}
.marquee:hover .marquee__track{animation-play-state:paused}
@keyframes marquee-loop{from{transform:translateX(0)}to{transform:translateX(-50%)}}

.logo{height:clamp(120px,22vw,200px); max-width:82vw; object-fit:contain; display:block; margin:10px auto 6px}

/* æ¨™é¡Œæ›´å¤§ */
.title-row h1{
  margin:0; color:#1f2f63;
  font-size:clamp(32px,5vw,48px); font-weight:800; letter-spacing:.7px;
}

/* âœ… ç›®å‰å¹´æœˆæ—¥æ™‚é–“ æ”¾å¤§ */
.now-time{
  color:#35579A; font-weight:800; margin-bottom:8px;
  font-size:clamp(16px,3.6vw,22px);
}

/* å…­é‚Šå½¢æ¨™ç±¤ï¼ˆé•·æ¢ï¼‰ï¼‹å­—é«”æ”¾å¤§ */
.pill-wrap{display:flex; justify-content:center; margin:8px 0 12px}
.hex{
  --cut:18px;
  display:inline-block; padding:.6rem 1.6rem;
  color:#fff; font-weight:800; letter-spacing:.6px;
  clip-path:polygon(var(--cut) 0, calc(100% - var(--cut)) 0, 100% 50%, calc(100% - var(--cut)) 100%, var(--cut) 100%, 0 50%);
  box-shadow:0 6px 16px rgba(0,0,0,.12);
  font-size:clamp(14px,3.6vw,20px);   /* âœ… æ”¾å¤§ */
}
.hex.red{background:var(--pill-red)}
.hex.coral{background:var(--pill-coral)}

/* å«è™Ÿï¼šç„¡åº•è‰²ã€æ¥·é«”ã€æ›´å¤§ã€ä¸è£œé›¶ */
.number-box{display:inline-block; margin:4px auto 12px}
.number{
  font-family:var(--digit-font);
  font-size:clamp(120px,20vw,260px); /* âœ… å·²å¾ˆå¤§ */
  line-height:1; color:var(--digit-red);
  letter-spacing:.02em; font-weight:700;
}
@keyframes pop{0%{transform:scale(.96);opacity:.85}100%{transform:scale(1);opacity:1}}
.pop{animation:pop .28s ease-out}

/* èªéŸ³æ ¸å–æ–¹å¡Š + ğŸ””/ğŸ”• */
.voice-row{display:flex; align-items:center; justify-content:center; gap:12px; margin:8px 0 16px}
.voice-label{font-weight:900; color:#3b2e1e; letter-spacing:.5px; font-size:clamp(16px,3vw,20px)}
.chk{width:22px; height:22px; margin:0; accent-color:var(--beige); appearance:auto; cursor:pointer}
.bell{font-size:22px; line-height:1}

/* âœ… æ³¨æ„äº‹é …æ•´æ®µæ”¾å¤§ï¼ˆå«è¡Œé«˜ï¼‰ */
.note{
  background:#F2F6FB; padding:18px 22px; border:none;
  margin:14px auto 12px; color:#274a6b; font-weight:700;
  width:min(760px,100%); text-align:center;
  font-size:clamp(14px,3.2vw,18px); line-height:1.75;
}
.note p{margin:.35em 0}

.palette{height:8px; margin:8px auto 14px; width:min(560px,90%); background:linear-gradient(to right,#D8C0AD 0 22%,#6db337 22% 45%,#35579A 45% 82%,#A5B8D0 82% 100%)}
.schedule{margin-top:6px; max-width:100%; border:none; box-shadow:none}

/* è¢å¹•é–±è®€å™¨ç”¨ */
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; white-space:nowrap}
</style>
</head>

<body>
  <div class="container">
    <!-- è·‘é¦¬ç‡ˆ -->
    <div class="marquee" aria-label="è¨ºæ‰€è¨Šæ¯è·‘é¦¬ç‡ˆ">
      <div class="marquee__track" id="marqueeTrack">
        <span>âœ¦ é™³è¬é¾è¨ºæ‰€é–€è¨ºæ™‚é–“ï¼šâ˜€ï¸ æ—©è¨º 08:30â€“11:30ï¼ˆæœ€æ™šå ±åˆ°10:30ï¼‰ï¼›â˜ï¸ åˆè¨º 14:00â€“17:00ï¼ˆæœ€æ™šå ±åˆ°16:00ï¼‰ï¼›â˜¾ æ™šè¨º 18:00â€“20:30ï¼ˆæœ€æ™šå ±åˆ°20:00ï¼‰ã€‚é€¾æ™‚è¦–åŒæ”¾æ£„ï¼Œåé¡å°‡é‡‹å‡ºçµ¦ç¾å ´æ›è™Ÿã€‚</span>
        <span aria-hidden="true">âœ¦ é™³è¬é¾è¨ºæ‰€é–€è¨ºæ™‚é–“ï¼šâ˜€ï¸ æ—©è¨º 08:30â€“11:30ï¼ˆæœ€æ™šå ±åˆ°10:30ï¼‰ï¼›â˜ï¸ åˆè¨º 14:00â€“17:00ï¼ˆæœ€æ™šå ±åˆ°16:00ï¼‰ï¼›â˜¾ æ™šè¨º 18:00â€“20:30ï¼ˆæœ€æ™šå ±åˆ°20:00ï¼‰ã€‚é€¾æ™‚è¦–åŒæ”¾æ£„ï¼Œåé¡å°‡é‡‹å‡ºçµ¦ç¾å ´æ›è™Ÿã€‚</span>
      </div>
    </div>

    <img class="logo" id="clinicLogo" src="./logo1.jpg" alt="é™³è¬é¾è¨ºæ‰€ LOGO">

    <div class="title-row"><h1 id="sectionTitle">ç›®å‰çœ‹è¨ºè™Ÿç¢¼</h1></div>
    <div class="now-time" id="twTime">â€”</div>

    <!-- å…­é‚Šå½¢æ¨™ç±¤ -->
    <div class="pill-wrap" aria-live="polite" id="statusPill"></div>

    <!-- å«è™Ÿï¼ˆç„¡åº•è‰²ã€ä¸è£œ0ï¼‰ -->
    <div class="number-box"><div id="bigNumber" class="number">â€”</div></div>

    <!-- èªéŸ³é–‹é—œ -->
    <div class="voice-row">
      <label class="voice-label" for="voiceToggle">é–‹å•ŸèªéŸ³å«è™Ÿæé†’</label>
      <input type="checkbox" id="voiceToggle" class="chk" aria-checked="false" aria-labelledby="voiceToggle"/>
      <span id="bell" class="bell" aria-hidden="true">ğŸ”•</span>
      <div id="voiceHint" class="sr-only">å‹¾é¸å¾Œï¼Œè™Ÿç¢¼è®Šæ›´æ™‚æœƒè‡ªå‹•èªéŸ³æ’­å ±ã€‚</div>
    </div>

    <div id="srStatus" class="sr-only" aria-live="polite"></div>

    <div class="note">
      <p>â™¦ï¸ é›²ç«¯è™Ÿç¢¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›å«è™Ÿä»¥ç¾å ´ç‚ºæº–ã€‚æ¯ä½ç—…æ‚£ç´„ 3â€“5 åˆ†é˜ï¼Œè«‹æå‰åˆ°å ´åœ¨å¯çœ‹åˆ°ç‡ˆè™Ÿçš„ä½ç½®ç­‰å€™ä»¥å…éè™Ÿã€‚</p>
      <p>â™¦ï¸ è‹¥å·²éè™Ÿè«‹å†æ¬¡å‘æ«ƒæª¯å ±åˆ°ï¼Œå°‡ä¾ç¾å ´ç‹€æ³èª¿æ•´å®‰æ’ã€‚é–€è¨ºå¯èƒ½è¦–ç¾å ´ç‹€æ³æå‰åœæ­¢æ›è™Ÿï¼Œå¦‚æœ‰ç–‘å•è«‹ä¾†é›» (03)515-2971ã€‚</p>
    </div>

    <div class="palette" aria-hidden="true"></div>
    <img class="schedule" id="scheduleImg" src="./schedule.png" alt="é–€è¨ºæ™‚é–“è¡¨">
  </div>

<script>
/* è·‘é¦¬ç‡ˆæš«åœ/æ¢å¾© */
(function(){
  const marquee=document.querySelector('.marquee');
  const track=document.getElementById('marqueeTrack');
  const pause=()=>track.style.animationPlayState='paused';
  const run=()=>track.style.animationPlayState='running';
  marquee.addEventListener('pointerdown',pause);
  marquee.addEventListener('pointerup',run);
  marquee.addEventListener('pointerleave',run);
  marquee.addEventListener('pointercancel',run);
})();

/* åœ–ç‰‡å‚™æ´ */
(function(){
  const logo=document.getElementById('clinicLogo');
  const logoFallbacks=['./logo.png',
    'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo1.jpg',
    'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo.png'];
  let li=0; logo.onerror=function(){ if(li<logoFallbacks.length){ this.src=logoFallbacks[li++]; } else { this.style.display='none'; } };

  const sch=document.getElementById('scheduleImg');
  const schFallbacks=['https://raw.githubusercontent.com/tioar/Clinic_calling/main/schedule.png'];
  let si=0; sch.onerror=function(){ if(si<schFallbacks.length){ this.src=schFallbacks[si++]; } else { this.style.display='none'; } };
})();

let lastNumber=''; /* ä¸é è¨­ 000 */

/* æŠ“è™Ÿè¨­å®š */
const POLL_MS=1500;
const FETCH_TIMEOUT=1200;
const GAS_URL="https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec";

/* ===== èªéŸ³è¨­å®š ===== */
const TTS_RATE=0.55;
const UA=navigator.userAgent.toLowerCase();
const isWinChrome=UA.includes('windows')&&UA.includes('chrome')&&!UA.includes('edg');
const WARM_CANCEL_DELAY=isWinChrome?220:120;
const WARM_PLAY_DELAY=isWinChrome?100:60;
const WARM_SAFETY_MS=isWinChrome?800:650;

const Voice={ready:false, unlocked:false, voices:[], zhVoice:null, enabled:false, timer:null};
function loadVoices(){
  const list=window.speechSynthesis?.getVoices?.()||[];
  Voice.voices=list;
  Voice.zhVoice=
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-tw'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-hk'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh-cn'))||
    list.find(v=>v.lang?.toLowerCase().startsWith('zh'));
}
function unlockTTS(){
  if(!('speechSynthesis' in window)){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­å ±'); return false; }
  loadVoices();
  if(typeof speechSynthesis.onvoiceschanged!=='undefined'){ speechSynthesis.onvoiceschanged=()=>loadVoices(); }
  try{ speechSynthesis.resume(); }catch(e){}
  Voice.unlocked=true; Voice.ready=true; return true;
}
function speakText(txt){
  if(!Voice.ready||!txt) return;
  if(!Voice.enabled && !speakText._oneshot) return;
  const play=()=>{
    const warm=new SpeechSynthesisUtterance('\u00A0');
    warm.lang=(Voice.zhVoice&&Voice.zhVoice.lang)||'zh-TW';
    warm.rate=TTS_RATE; warm.pitch=1; warm.volume=0;
    const safety=setTimeout(()=>{ try{ speechSynthesis.cancel(); }catch(e){} reallySpeak(txt); }, isWinChrome?800:650);
    warm.onend=()=>{ clearTimeout(safety); setTimeout(()=>reallySpeak(txt), isWinChrome?100:60); };
    try{ speechSynthesis.resume(); }catch(e){}
    speechSynthesis.speak(warm);
  };
  if(speechSynthesis.speaking||speechSynthesis.pending){
    try{ speechSynthesis.cancel(); }catch(e){}
    setTimeout(play, isWinChrome?220:120);
  }else{
    setTimeout(play, isWinChrome?100:60);
  }
}
function reallySpeak(txt){
  const u=new SpeechSynthesisUtterance((UA.includes('windows')?'\u3000ï¼Œ':'')+String(txt).replace(/[~ï½]+$/g,'ã€‚'));
  if(!Voice.zhVoice||!Voice.voices.length) loadVoices();
  if(Voice.zhVoice) u.voice=Voice.zhVoice;
  u.lang=(Voice.zhVoice&&Voice.zhVoice.lang)||'zh-TW';
  u.rate=TTS_RATE; u.pitch=1; u.volume=1;
  u.onstart=()=>{ try{ speechSynthesis.resume(); }catch(e){} };
  speechSynthesis.speak(u);
}
function zhRead(n){
  n=Math.max(0,Math.min(999,Math.floor(n)));
  const d=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  if(n===0) return 'é›¶';
  let out='',h=Math.floor(n/100),t=Math.floor((n%100)/10),u=n%10;
  if(h>0){ out+=d[h]+'ç™¾'; if(t===0 && u>0) out+='é›¶'; }
  if(t>0){ out+=(t===1 && h===0?'':d[t])+'å'; }
  if(u>0){ out+=d[u]; }
  return out;
}
function speakNumber(n){ speakText(`${zhRead(n)}è™Ÿã€${zhRead(n)}è™Ÿè«‹é€²è¨ºé–“ã€‚`); }

/* SR */
const srStatus=document.getElementById('srStatus');
function sayToSR(text){ srStatus.textContent=text; }

/* èªéŸ³æ ¸å–æ–¹å¡Š */
const voiceToggle=document.getElementById('voiceToggle');
const bell=document.getElementById('bell');
voiceToggle.addEventListener('change',()=>{
  voiceToggle.setAttribute('aria-checked', voiceToggle.checked?'true':'false');
  bell.textContent=voiceToggle.checked?'ğŸ””':'ğŸ”•';
  if(voiceToggle.checked){
    if(!Voice.unlocked && !unlockTTS()){ voiceToggle.checked=false; voiceToggle.setAttribute('aria-checked','false'); bell.textContent='ğŸ”•'; return; }
    Voice.enabled=true;
    speakText._oneshot=true; speakText('å·²é–‹å•ŸèªéŸ³å«è™Ÿæé†’ã€‚'); speakText._oneshot=false;
    sayToSR('å·²é–‹å•ŸèªéŸ³å«è™Ÿæé†’');
  }else{
    Voice.enabled=false; try{ speechSynthesis.cancel(); }catch(e){}
    sayToSR('å·²é—œé–‰èªéŸ³å«è™Ÿæé†’');
  }
});
window.addEventListener('touchend',function once(){ if(!Voice.unlocked){ unlockTTS(); } window.removeEventListener('touchend',once,true); },true);
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ try{ speechSynthesis.resume(); }catch(e){} }});

/* æŠ“è™Ÿï¼ˆä¸è£œ 0ï¼‰ */
async function fetchJSON(){
  const ctrl=new AbortController();
  const t=setTimeout(()=>ctrl.abort(), 1200);
  const res=await fetch(`${"https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec"}?ts=${Date.now()}`,{cache:'no-store', signal:ctrl.signal});
  clearTimeout(t);
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}
function fetchJSONP(){
  return new Promise((resolve,reject)=>{
    const cb='onClinic_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    const s=document.createElement('script');
    const done=()=>{ delete window[cb]; s.remove(); };
    const to=setTimeout(()=>{ done(); reject(new Error('jsonp timeout')); },5000);
    window[cb]=(d)=>{ clearTimeout(to); done(); resolve(d); };
    s.src=`https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec?callback=${cb}&ts=${Date.now()}`;
    s.onerror=()=>{ clearTimeout(to); done(); reject(new Error('jsonp error')); };
    document.head.appendChild(s);
  });
}

function renderStatusPill(data){
  const box=document.getElementById('statusPill');
  box.innerHTML='';
  if(data.holiday===true){
    const el=document.createElement('div'); el.className='hex red'; el.textContent='ç¾åœ¨æ™‚é–“æ²’æœ‰é–€è¨ºï¼Œä¼‘è¨ºä¸­'; box.appendChild(el);
  }else if(data.closed===true){
    const el=document.createElement('div'); el.className='hex coral'; el.textContent='ç•¶å‰æ™‚æ®µå·²åœæ­¢æ›è™Ÿ'; box.appendChild(el);
  }
}
function animateNumberText(text){
  const el=document.getElementById('bigNumber');
  el.textContent=text;
  el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop');
}
async function fetchNumber(){
  try{
    const data=await fetchJSON().catch(async()=>await fetchJSONP());
    renderStatusPill(data);
    const n=Number(data.number);
    if(!Number.isFinite(n)||n<0||n>=1000) return;
    const current=String(n); // ä¸è£œ 0
    if(current!==lastNumber){
      animateNumberText(current);
      sayToSR(`ç›®å‰çœ‹è¨ºè™Ÿç¢¼ï¼š${current}`);
      if(Voice.enabled) speakNumber(n);
      lastNumber=current;
    }
  }catch(e){}
}

/* æ™‚é–“ */
const pad2=n=>String(n).padStart(2,'0');
function updateTWTime(){
  const el=document.getElementById('twTime');
  const now=new Date();
  const tw=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  el.textContent=`${tw.getFullYear()}/${pad2(tw.getMonth()+1)}/${pad2(tw.getDate())} (${w[tw.getDay()]}) ${pad2(tw.getHours())}:${pad2(tw.getMinutes())}:${pad2(tw.getSeconds())}`;
}

/* å•Ÿå‹• */
fetchNumber(); setInterval(fetchNumber, 1500);
updateTWTime(); setInterval(updateTWTime, 1000);
</script>
</body>
</html>
