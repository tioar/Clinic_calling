<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>陳萬龍診所看診進度</title>
<meta name="description" content="即時看診進度與門診資訊">
<meta name="theme-color" content="#35579A">

<meta property="og:type" content="website">
<meta property="og:title" content="陳萬龍診所｜看診進度">
<meta property="og:description" content="即時看診進度與門診資訊。">
<meta property="og:image" content="og-cover.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://tioar.github.io/Clinic_calling/">
<meta property="og:locale" content="zh_TW">

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@700;800;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    --primary:#35579A;
    --purple:#6B5AAE;
    --soft:#A5B8D0;
    --beige:#D8C0AD;
    --accent:#6db337;
    --bg:#F5EFE8;
    --card:#FFFFFF;
    --note:#F2F6FB;
    --digit-red:#DC2626;
    --pill-red:#E53935;
    --pill-coral:#F37163;
  }
  *{ box-sizing:border-box; }
  body{
    font-family:'Noto Sans TC',sans-serif;
    -webkit-font-smoothing:antialiased;
    background:var(--bg);
    margin:0;
    padding:clamp(16px,4vw,40px) max(12px,env(safe-area-inset-left)) clamp(24px,6vw,48px) max(12px,env(safe-area-inset-right));
    display:flex; justify-content:center; color:#1c1c1c;
  }
  .container{
    position:relative;
    width:min(860px,96vw);
    background:var(--card);
    border-radius:36px;
    padding:clamp(16px,4vw,32px);
    text-align:center;
    box-shadow:0 10px 30px rgba(53,87,154,0.10);
    border:3px solid var(--primary);
    overflow:visible;
  }

  /* 跑馬燈 */
  .marquee{
    --gap: 2rem; --speed: 45s;
    background:var(--purple); color:#fff;
    border-radius:18px; padding:10px 0; margin:0 auto 10px;
    overflow:hidden; white-space:nowrap; user-select:none; font-size:14px;
  }
  .marquee__track{ display:inline-flex; align-items:center; width:max-content; animation:marquee-loop var(--speed) linear infinite; }
  .marquee__track > span{ padding-right:var(--gap); flex-shrink:0; }
  .marquee:hover .marquee__track{ animation-play-state:paused; }
  @keyframes marquee-loop{ from{transform:translateX(0)} to{transform:translateX(-50%)} }

  .logo-wrap{ margin:10px 0 0; }
  .logo{ height:clamp(120px,22vw,200px); max-width:82vw; object-fit:contain; background:#fff; }

  .pill-wrap{ display:flex; justify-content:center; margin:10px 0 6px; min-height:0; }
  .pill{ display:inline-flex; align-items:center; justify-content:center; padding:10px 18px; border-radius:999px; color:#fff; font-weight:900; box-shadow:0 8px 18px rgba(0,0,0,.12); letter-spacing:.5px; max-width:90%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:16px; }
  .pill.red{ background:var(--pill-red); }
  .pill.coral{ background:var(--pill-coral); }

  /* 標題 */
  .title-row{ display:flex; align-items:center; justify-content:center; gap:12px; margin:12px 0 6px; flex-wrap:wrap; }
  h1{ margin:0; color:#35579A; letter-spacing:1px; }

  .now-time{ color:#5f7396; font-weight:700; margin-bottom:18px; }

  .number-display{ display:flex; justify-content:center; gap:clamp(8px,2vw,16px); margin-bottom:8px; }
  .digit-card{
    width:clamp(72px,22vw,110px); height:clamp(92px,28vw,140px);
    background:#fff; color:var(--digit-red); font-family:'Manrope',sans-serif;
    font-variant-numeric:tabular-nums; font-size:clamp(56px,16vw,100px); font-weight:800; line-height:1;
    border-radius:28px; display:flex; align-items:center; justify-content:center;
    position:relative; perspective:400px; overflow:hidden;
    box-shadow:0 10px 24px rgba(53,87,154,.08), inset 0 0 0 3px var(--soft);
  }
  .digit-card .current,.digit-card .next{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; }
  .digit-card .next{ transform:rotateX(-180deg); }
  .flip .current{ animation:flipTop .5s forwards; }
  .flip .next{ animation:flipBottom .5s forwards; }
  @keyframes flipTop{0%{transform:rotateX(0)}100%{transform:rotateX(180deg)}}
  @keyframes flipBottom{0%{transform:rotateX(-180deg)}100%{transform:rotateX(0)}}

  /* 語音開關（放在號碼下方；手機也維持單行） */
  .voice-row{
    display:flex; align-items:center; justify-content:center;
    gap:10px; margin:10px 0 16px;
    flex-wrap:nowrap; /* 優先單行 */
  }
  .voice-label{
    font-weight:900; color:#4b3e7a; letter-spacing:.5px;
    font-size:clamp(14px,3.5vw,18px);
  }
  .switch{ position:relative; width:64px; height:36px; flex:0 0 auto; }
  .switch input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; margin:0; cursor:pointer; }
  .track{ position:absolute; inset:0; background:#d9d2f1; border-radius:999px; transition:.25s ease; box-shadow:inset 0 0 0 2px rgba(0,0,0,.06); }
  .thumb{ position:absolute; top:3px; left:3px; width:30px; height:30px; border-radius:50%; background:#fff; display:grid; place-items:center; transition:.25s ease; box-shadow:0 4px 12px rgba(0,0,0,.15); font-size:18px; }
  .switch input:checked ~ .track{ background:var(--purple); }
  .switch input:checked ~ .thumb{ left:31px; color:var(--purple); }

  /* 超小螢幕：縮小字與按鈕，保單行（例如 320px 寬） */
  @media (max-width:380px){
    .voice-label{ font-size:13px; }
    .switch{ width:52px; height:30px; }
    .thumb{ width:24px; height:24px; top:3px; left:3px; font-size:16px; }
    .switch input:checked ~ .thumb{ left:25px; }
    .voice-row{ gap:8px; }
  }

  .note{ background:var(--note); padding:16px 20px; border-radius:22px; margin:16px auto 12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); color:#274a6b; font-weight:600; width:min(760px,100%); text-align:center; }
  .note p{ margin:.35em 0; }

  .palette{ height:8px; border-radius:6px; margin:8px auto 16px; width:min(560px,90%); background:linear-gradient(to right,var(--beige) 0 22%,var(--accent) 22% 45%,var(--primary) 45% 82%,var(--soft) 82% 100%); }
  .schedule{ margin-top:6px; max-width:100%; border-radius:20px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }

  .popup{ position:absolute; left:50%; transform:translateX(-50%); background:var(--accent); color:#fff; padding:14px 22px; border-radius:999px; font-size:20px; z-index:10; font-weight:800; opacity:0; animation:fadeInOut 3s forwards; box-shadow:0 12px 26px rgba(0,0,0,.15); pointer-events:none; white-space:nowrap; max-width:90%; overflow:hidden; text-overflow:ellipsis; }
  @keyframes fadeInOut{0%{opacity:0; transform:translate(-50%,-6px)}10%{opacity:1; transform:translate(-50%,0)}90%{opacity:1}100%{opacity:0; transform:translate(-50%,-6px)}}

  /* 無障礙：僅給螢幕閱讀器的提示區域 */
  .sr-only{
    position:absolute !important; width:1px; height:1px;
    padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
    border:0; white-space:nowrap;
  }
</style>
</head>

<body>
  <div class="container">
    <div class="marquee" aria-label="診所訊息跑馬燈">
      <div class="marquee__track" id="marqueeTrack">
        <span>✦ 陳萬龍診所門診時間：☀︎ 早診 08:30–11:30（最晚報到10:30）；☁︎ 午診 14:00–17:00（最晚報到16:00）；☾ 晚診 18:00–20:30（最晚報到20:00）。逾時視同放棄，名額將釋出給現場掛號。</span>
        <span aria-hidden="true">✦ 陳萬龍診所門診時間：☀︎ 早診 08:30–11:30（最晚報到10:30）；☁︎ 午診 14:00–17:00（最晚報到16:00）；☾ 晚診 18:00–20:30（最晚報到20:00）。逾時視同放棄，名額將釋出給現場掛號。</span>
      </div>
    </div>

    <div class="logo-wrap">
      <img class="logo" id="clinicLogo" src="./logo1.jpg" alt="陳萬龍診所 LOGO">
    </div>

    <div class="pill-wrap" aria-live="polite" id="statusPill"></div>

    <div class="title-row">
      <h1 id="sectionTitle">目前看診號碼</h1>
    </div>

    <div class="now-time" id="twTime">—</div>

    <!-- 號碼顯示：讓讀屏能聽到變化 -->
    <div class="number-display" id="numberDisplay" aria-live="polite" aria-atomic="true" aria-label="目前看診號碼">
      <div class="digit-card"><div class="current">0</div><div class="next">0</div></div>
      <div class="digit-card"><div class="current">0</div><div class="next">0</div></div>
      <div class="digit-card"><div class="current">0</div><div class="next">0</div></div>
    </div>

    <!-- 開啟語音叫號提醒（號碼下方／行內顯示） -->
    <div class="voice-row">
      <div class="voice-label" id="voiceText">開啟語音叫號提醒</div>
      <label class="switch" id="voiceSwitchLabel" aria-label="開啟語音叫號提醒開關">
        <input
          type="checkbox"
          id="voiceToggle"
          role="switch"
          aria-checked="false"
          aria-labelledby="voiceText"
          aria-describedby="voiceHint"
        />
        <div class="track"></div>
        <div class="thumb" aria-hidden="true">🔊</div>
      </label>
      <div id="voiceHint" class="sr-only">開啟後，號碼變更時會自動語音播報。</div>
    </div>

    <!-- 給讀屏的即時狀態提示 -->
    <div id="srStatus" class="sr-only" aria-live="polite"></div>

    <div class="note">
      <p>♦︎ 雲端號碼僅供參考，實際叫號以現場為準。每位患者約 3–5 分鐘，請提前到場在可看到燈號的位置等候以免過號。</p>
      <p>♦︎ 若已過號請再次向櫃檯報到，將依現場狀況調整安排。</p>
      <p>♦︎ 門診可能視現場狀況提前停止掛號，如有疑問請來電 (03)5152971。</p>
    </div>

    <div class="palette" aria-hidden="true"></div>
    <img class="schedule" id="scheduleImg" src="./schedule.png" alt="門診時間表">
  </div>

  <script>
    /* 跑馬燈暫停/恢復 */
    (function(){
      const marquee = document.querySelector('.marquee');
      const track = document.getElementById('marqueeTrack');
      const pause = () => track.style.animationPlayState = 'paused';
      const run   = () => track.style.animationPlayState = 'running';
      marquee.addEventListener('pointerdown', pause);
      marquee.addEventListener('pointerup', run);
      marquee.addEventListener('pointerleave', run);
      marquee.addEventListener('pointercancel', run);
    })();

    /* 圖片備援 */
    (function(){
      const logo = document.getElementById('clinicLogo');
      const logoFallbacks = [
        './logo.png',
        'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo1.jpg',
        'https://raw.githubusercontent.com/tioar/Clinic_calling/main/logo.png'
      ];
      let li=0; logo.onerror = function(){ if(li<logoFallbacks.length){ this.src=logoFallbacks[li++]; } else { this.style.display='none'; } };

      const sch = document.getElementById('scheduleImg');
      const schFallbacks = ['https://raw.githubusercontent.com/tioar/Clinic_calling/main/schedule.png'];
      let si=0; sch.onerror = function(){ if(si<schFallbacks.length){ this.src=schFallbacks[si++]; } else { this.style.display='none'; } };
    })();

    let lastNumber='000';

    /* 抓號設定（單一宣告，避免重覆） */
    const POLL_MS = 1500;           // 輪詢間隔
    const FETCH_TIMEOUT = 1200;     // 單次請求逾時
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxHI3ypQqfqnEpXVDO6WJq0EQjkMWzjpIvosYGwu43MP9iiXjofRnZOzOnhAXedwCLw/exec"; // ← 換成你的 /exec

    /* ===== 語音設定 ===== */
    const TTS_RATE = 0.75;
    const UA = navigator.userAgent.toLowerCase();
    const isWinChrome = UA.includes('windows') && UA.includes('chrome') && !UA.includes('edg');
    const WARM_CANCEL_DELAY = isWinChrome ? 220 : 120;
    const WARM_PLAY_DELAY   = isWinChrome ? 100 : 60;
    const WARM_SAFETY_MS    = isWinChrome ? 800 : 650;

    const Voice = { ready:false, unlocked:false, voices:[], zhVoice:null, enabled:false, timer:null };
    function loadVoices(){
      const list = window.speechSynthesis?.getVoices?.() || [];
      Voice.voices = list;
      Voice.zhVoice =
        list.find(v => v.lang?.toLowerCase().startsWith('zh-tw')) ||
        list.find(v => v.lang?.toLowerCase().startsWith('zh-hk')) ||
        list.find(v => v.lang?.toLowerCase().startsWith('zh-cn')) ||
        list.find(v => v.lang?.toLowerCase().startsWith('zh'));
    }
    function unlockTTS(){
      if(!('speechSynthesis' in window)){ alert('此瀏覽器不支援語音播報'); return false; }
      loadVoices();
      if(typeof speechSynthesis.onvoiceschanged !== 'undefined'){
        speechSynthesis.onvoiceschanged = () => loadVoices();
      }
      try{ speechSynthesis.resume(); }catch(e){}
      Voice.unlocked = true; Voice.ready = true; return true;
    }
    function speakText(txt){
      if(!Voice.ready || !txt) return;
      if (!Voice.enabled && !speakText._oneshot) return;
      if (Voice.timer){ clearTimeout(Voice.timer); Voice.timer = null; }
      const play = () => {
        const warm = new SpeechSynthesisUtterance('\u00A0'); // 無聲暖機
        warm.lang = (Voice.zhVoice && Voice.zhVoice.lang) || 'zh-TW';
        warm.rate = TTS_RATE; warm.pitch = 1; warm.volume = 0;

        const safety = setTimeout(() => {
          try{ speechSynthesis.cancel(); }catch(e){}
          reallySpeak(txt);
        }, WARM_SAFETY_MS);

        warm.onend = () => {
          clearTimeout(safety);
          setTimeout(() => reallySpeak(txt), WARM_PLAY_DELAY);
        };

        try{ speechSynthesis.resume(); }catch(e){}
        speechSynthesis.speak(warm);
      };

      if (speechSynthesis.speaking || speechSynthesis.pending){
        try{ speechSynthesis.cancel(); }catch(e){}
        setTimeout(play, WARM_CANCEL_DELAY);
      } else {
        setTimeout(play, WARM_PLAY_DELAY);
      }
    }
    function reallySpeak(txt){
      const safeTail = String(txt).replace(/[~～]+$/g,'。');      // Android 尾字防呆
      const prefix = isWinChrome ? '\u3000，' : '';               // Windows Chrome 偶發吞頭防呆
      const u = new SpeechSynthesisUtterance(prefix + safeTail);
      if(!Voice.zhVoice || !Voice.voices.length) loadVoices();
      if(Voice.zhVoice) u.voice = Voice.zhVoice;
      u.lang = (Voice.zhVoice && Voice.zhVoice.lang) || 'zh-TW';
      u.rate = TTS_RATE;  u.pitch = 1;  u.volume = 1;
      u.onstart = ()=>{ try{ speechSynthesis.resume(); }catch(e){} };
      speechSynthesis.speak(u);
    }
    function zhRead(n){
      n = Math.max(0, Math.min(999, Math.floor(n)));
      const d = ['零','一','二','三','四','五','六','七','八','九'];
      if (n === 0) return '零';
      let out = '', h = Math.floor(n/100), t = Math.floor((n%100)/10), u = n%10;
      if(h>0){ out += d[h]+'百'; if(t===0 && u>0) out+='零'; }
      if(t>0){ out += (t===1 && h===0 ? '' : d[t]) + '十'; }
      if(u>0){ out += d[u]; }
      return out;
    }
    function speakNumber(n){
      const zh = zhRead(n);
      speakText(`第${zh}號、第${zh}號請進診間。`);
    }

    // 無障礙讀屏提示
    const srStatus = document.getElementById('srStatus');
    function sayToSR(text){ srStatus.textContent = text; }

    // 語音開關（同步 aria 狀態）
    const voiceToggle = document.getElementById('voiceToggle');
    voiceToggle.addEventListener('change', ()=>{
      voiceToggle.setAttribute('aria-checked', voiceToggle.checked ? 'true' : 'false');
      if(voiceToggle.checked){
        if(!Voice.unlocked && !unlockTTS()){ voiceToggle.checked=false; voiceToggle.setAttribute('aria-checked','false'); return; }
        Voice.enabled = true;
        speakText._oneshot = true;
        speakText('已開啟語音叫號提醒。');
        speakText._oneshot = false;
        sayToSR('已開啟語音叫號提醒');
      }else{
        Voice.enabled = false;
        speechSynthesis.cancel();
        sayToSR('已關閉語音叫號提醒');
      }
    });

    // 行動裝置友善解鎖 & 回前景 resume
    window.addEventListener('touchend', function once(){
      if(!Voice.unlocked){ unlockTTS(); }
      window.removeEventListener('touchend', once, true);
    }, true);
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){
        try{ speechSynthesis.resume(); }catch(e){}
      }
    });

    /* ===== 抓號：先用 fetch，失敗再 JSONP 後備 ===== */
    async function fetchJSON() {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), FETCH_TIMEOUT);
      const res = await fetch(`${GAS_URL}?ts=${Date.now()}`, { cache:'no-store', signal: ctrl.signal });
      clearTimeout(t);
      if(!res.ok) throw new Error(res.statusText);
      return res.json();
    }
    function fetchJSONP() {
      return new Promise((resolve, reject) => {
        const cbName = 'onClinicData_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
        const s = document.createElement('script');
        const timeout = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, 5000);
        window[cbName] = (data) => { cleanup(); resolve(data); };
        function cleanup(){ clearTimeout(timeout); delete window[cbName]; s.remove(); }
        s.src = `${GAS_URL}?callback=${cbName}&ts=${Date.now()}`;
        s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
        document.head.appendChild(s);
      });
    }

    async function fetchNumber(){
      try{
        const data = await fetchJSON().catch(async () => await fetchJSONP());
        renderStatusPill(data);
        const n = Number(data.number);
        if (!Number.isFinite(n) || n < 0 || n >= 1000) return;
        const current = String(n).padStart(3,'0');
        if(current !== lastNumber){
          animateNumber(current);
          showPopup(`請 ${current} 號就診`);
          sayToSR(`目前看診號碼：${current}`); // 讀屏即時提示
          if (Voice.enabled) speakNumber(n);
          lastNumber = current;
        }
      }catch(err){
        // 可視需要打開除錯：console.warn('抓號失敗：', err?.message || err);
      }
    }

    function renderStatusPill(data){
      const box = document.getElementById('statusPill');
      box.innerHTML = '';
      if (data.holiday === true){
        const el = document.createElement('div');
        el.className = 'pill red';
        el.textContent = '現在時間沒有門診，休診中';
        box.appendChild(el);
      } else if (data.closed === true){
        const el = document.createElement('div');
        el.className = 'pill coral';
        el.textContent = '當前時段門診已經停止掛號';
        box.appendChild(el);
      }
    }

    const pad2 = n => String(n).padStart(2,'0');
    function animateNumber(newNumber){
      const digits=document.querySelectorAll('#numberDisplay .digit-card');
      newNumber.split('').forEach((d,i)=>{
        const card=digits[i];
        const cur=card.querySelector('.current');
        const nxt=card.querySelector('.next');
        if(cur.innerText!==d){
          nxt.innerText=d;
          card.classList.add('flip');
          setTimeout(()=>{ cur.innerText=d; card.classList.remove('flip'); },500);
        }
      });
    }
    function updateTWTime(){
      const el=document.getElementById('twTime');
      const now = new Date();
      const tw = new Date(now.toLocaleString('en-US', { timeZone:'Asia/Taipei' }));
      const wMap = ['日','一','二','三','四','五','六'];
      el.textContent = `${tw.getFullYear()}/${pad2(tw.getMonth()+1)}/${pad2(tw.getDate())} (${wMap[tw.getDay()]}) `+
                       `${pad2(tw.getHours())}:${pad2(tw.getMinutes())}:${pad2(tw.getSeconds())}`;
    }
    function showPopup(msg){
      const container=document.querySelector('.container');
      const logo=document.getElementById('clinicLogo');
      const popup=document.createElement('div');
      popup.className='popup';
      popup.textContent=msg;
      container.appendChild(popup);
      const top = logo.offsetTop + logo.offsetHeight + 8;
      popup.style.top = top + 'px';
      setTimeout(()=>popup.remove(),3000);
    }

    // 啟動
    fetchNumber();
    setInterval(fetchNumber, POLL_MS);
    updateTWTime(); setInterval(updateTWTime, 1000);
  </script>
</body>
</html>
